<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stations-service proches</title>
</head>
<body>
  <h1>Stations-service autour de vous</h1>
  <div id="status">Chargement des donn√©es‚Ä¶</div>
  <ul id="station-list"></ul>

  <script>
    async function fetchStations() {
      try {
        const res = await fetch('/api/carburants');
        const stations = await res.json();

        if (!navigator.geolocation) throw new Error("G√©olocalisation non disponible");

        navigator.geolocation.getCurrentPosition((pos) => {
          const { latitude: lat, longitude: lon } = pos.coords;

          const list = stations.map((station) => {
            const d = distance(lat, lon, station.lat, station.lon).toFixed(1);
            return { ...station, distance: d };
          }).sort((a, b) => a.distance - b.distance);

          document.getElementById("station-list").innerHTML = list.slice(0, 20).map(s => `
            <li>
              <strong>${s.ville}</strong> ‚Äì ${s.adresse}<br/>
              ${s.carburants.map(c => `${c.nom}: ${c.valeur}‚Ç¨`).join(" / ")}<br/>
              üìç ${s.distance} km
            </li>`).join("");

          document.getElementById("status").remove();
        }, () => {
          throw new Error("Autorisation g√©olocalisation refus√©e");
        });
      } catch (e) {
        document.getElementById("status").innerText = "Erreur lors du chargement des donn√©es";
        console.error(e);
      }
    }

    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371; // km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    fetchStations();
  </script>
</body>
</html>
