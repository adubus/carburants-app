<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stations-service autour de moi</title>
</head>
<body>
  <h1>‚õΩ Stations-service autour de moi</h1>
  <p id="loading">Chargement des donn√©es‚Ä¶</p>
  <ul id="station-list"></ul>

  <script>
    const API_URL = '/api/carburants';

    function getDistanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) ** 2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    async function init() {
      try {
        const response = await fetch(API_URL);
        if (!response.ok) throw new Error(`${response.status} ${response.statusText}`);
        const stations = await response.json();

        if (!navigator.geolocation) throw new Error("G√©olocalisation non disponible");
        navigator.geolocation.getCurrentPosition((position) => {
          const { latitude: lat, longitude: lon } = position.coords;
          const list = stations.map(s => ({
            ...s,
            distance: getDistanceKm(lat, lon, s.lat, s.lon)
          })).sort((a, b) => a.distance - b.distance);

          document.getElementById('loading').remove();
          const el = document.getElementById('station-list');
          list.slice(0, 20).forEach(s => {
            const item = document.createElement('li');
            item.innerHTML = `<strong>${s.ville}</strong> ‚Äì ${s.adresse}<br>
              ${s.carburants.map(c => `${c.nom}‚ÄØ: ${c.valeur}‚ÄØ‚Ç¨`).join(' | ')}<br>
              üìç ${s.distance.toFixed(2)} km`;
            el.appendChild(item);
          });
        }, (err) => {
          throw new Error("Autorisation g√©olocalisation refus√©e");
        });
      } catch (err) {
        console.error("Erreur API ou g√©oloc :", err);
        document.getElementById('station-list').innerHTML = "";
        const msg = document.getElementById('loading');
        msg.textContent = `Erreur : ${err.message}`;
      }
    }

    init();
  </script>
</body>
</html>